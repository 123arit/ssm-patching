- hosts: localhost
  connection: local
  tasks:
  - name: Creating the lambda function
    shell: aws lambda create-function --function-name "{{function_name}}" --runtime "{{runtime}}" --zip-file "fileb://{{zip_file_name_with_ext}}" --handler "{{function_handler}}" --role "{{lambda_role_arn}}" --timeout 300 --region "{{region}}"| jq -r .FunctionArn
    register: var1
  - debug:
      msg: "{{var1}}"
  - name: Create Restful API
    shell: aws apigateway create-rest-api --name '{{function_name}}' --description 'API Gateway to trigger lambda for patching' --region "{{region}}"| jq -r .id
    register: var2
    when: var1 != ""
  - debug:
      msg: "{{var2}}"
  - name: Integrating Lambda with the API Gateway
    shell: aws lambda create-event-source-mapping --event-source-arn 'arn:aws:apigateway:{{region}}::/restapis/{{var2}}/stages/default' --function-name "{{function_name}}"
    when: var2 != ""
